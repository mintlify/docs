---
title: "AWS Route 53 和 CloudFront"
sidebarTitle: "AWS"
description: "使用 AWS 服务在 /docs 子目录托管文档"
---

import Propagating from "/snippets/custom-subpath-propagating.mdx";

若要使用 AWS Route 53 和 CloudFront 在 `/docs` 子路径托管文档，你需要将 DNS 提供商配置为指向你的 CloudFront 分配。

## 在 Vercel 部署中使用代理

如果你在 Vercel 部署中使用 AWS CloudFront 作为代理，必须正确配置 CloudFront，避免干扰 Vercel 的域名验证和 SSL 证书签发。

错误的 CloudFront 配置可能会阻止 Vercel 申请并签发 Let's Encrypt SSL 证书，并导致域名验证失败。

### 必需的路径白名单

CloudFront 必须允许以下特定路径的流量，且不得缓存或拦截：

- `/.well-known/acme-challenge/*` - 用于 Let's Encrypt 证书验证
- `/.well-known/vercel/*` - 用于 Vercel 域名验证

这些路径应配置为绕过 CloudFront 缓存，并直接透传到源站。

### 请求头转发要求

你必须创建一个自定义源站请求策略，正确转发 `HOST` 请求头和客户端 IP 信息。这对 Vercel 的验证流程至关重要。

1. 创建名为 `VercelCloudFrontProxy` 的自定义源站请求策略。
2. 包含 `Origin` 和 `CloudFront-Viewer-Address` 请求头。

你必须在源站请求策略或缓存策略的请求头配置中包含 `CloudFront-Viewer-Address` 请求头，以将该请求头转发到源站。

## 创建 CloudFront 分配

1. 在 AWS 控制台中进入 [CloudFront](https://aws.amazon.com/cloudfront)。
2. 选择 **Create distribution**。

  <Frame>
    ![CloudFront 分配页面，突出显示“Create distribution”按钮。](/zh/images/cloudfront/create-distribution.png)
  </Frame>

3. 在 Origin domain 中输入 `[SUBDOMAIN].mintlify.dev`，其中 `[SUBDOMAIN]` 是你项目的唯一子域名。

  <Frame>
    ![CloudFront “Create distribution” 页面，显示将 “acme.mintlify.dev” 作为 Origin domain。](/zh/images/cloudfront/origin-name.png)
  </Frame>

4. 在 “Web Application Firewall (WAF)” 中，启用安全防护。

  <Frame>
    ![Web Application Firewall (WAF) 选项，已选择 “Enable security protections”。](/zh/images/cloudfront/enable-security-protections.png)
  </Frame>

5. 其余设置保持默认。
6. 选择 **Create distribution**。

## 添加默认源站

1. 创建分发后，前往“Origins”选项卡。

  <Frame>
    ![CloudFront 分发中高亮显示“Origins”选项卡。](/zh/images/cloudfront/origins.png)
  </Frame>

2. 找到与你主域名对应的预发布环境 URL。具体取决于落地页的托管方式会有较大差异。例如，Mintlify 的预发布环境 URL 是 [mintlify-landing-page.vercel.app](https://mintlify-landing-page.vercel.app)。

<Info>
  如果你的落地页托管在 Webflow，请使用 Webflow 的预发布环境 URL，通常以 `.webflow.io` 结尾。

  如果你使用 Vercel，请使用每个项目默认提供的 `.vercel.app` 域名。
</Info>

3. 新建一个 Origin，并将你的预发布环境 URL 填入“Origin domain”。

  <Frame>
    ![CloudFront 的“Create origin”页面，高亮显示“Origin domain”输入框。](/zh/images/cloudfront/default-origin.png)
  </Frame>

此时，你应该有两个 Origins：一个是 `[SUBDOMAIN].mintlify.app`，另一个是你的预发布环境 URL。

<Frame>
  ![CloudFront 的“Origins”页面，包含两个 origin：一个用于 `mintlify`，另一个用于 `mintlify-landing-page`。](/zh/images/cloudfront/final-origins.png)
</Frame>

## 设置行为

CloudFront 的行为用于控制子路径路由逻辑。总体目标是实现如下逻辑：

- 如果用户访问 /docs，跳转到 `[SUBDOMAIN].mintlify.dev`。
- 如果用户访问其他任意页面，跳转到当前落地页。

1. 打开你的 CloudFront 分配中的 “Behaviors” 选项卡。

<Frame>
	![突出显示 CloudFront 的 "Behaviors" 选项卡。](/zh/images/cloudfront/behaviors.png)
</Frame>

2. 点击 **Create behavior**，并创建以下行为。

### `/.well-known/*`

为 Vercel 域名验证路径创建行为，将 **Path pattern** 设置为 `/.well-known/*`，并将 **Origin and origin groups** 指向你的文档 URL。

在 “Cache policy” 中选择 **CachingDisabled**，确保这些验证请求跳过缓存直通源站。

<Frame>
  ![CloudFront 的 "Create behavior" 页面，"Path pattern" 为 "/.well-known/*"，"Origin and origin groups" 指向预发布环境 URL。](/zh/images/cloudfront/well-known-policy.png)
</Frame>

<Info>
如果 `/.well-known/*` 过于宽泛，至少可为 Vercel 拆分为 2 个行为：
  - `/.well-known/vercel/*` - 用于 Vercel 域名验证
  - `/.well-known/acme-challenge/*` - 用于 Let's Encrypt 证书验证
</Info>

### `/docs`

创建一个 **Path pattern** 为 `/docs` 的行为，将 **Origin and origin groups** 指向 `.mintlify.dev` URL（此处为 `acme.mintlify.dev`）。

- 将 “Cache policy” 设置为 **CachingOptimized**。
- 在 “Origin request policy” 中创建名为 **VercelCloudFrontProxy** 的源请求策略，用于转发 `Origin` 和 `CloudFront-Viewer-Address` 请求头。

<Frame>
	![CloudFront 创建源请求策略页面，转发 `Origin` 和 `CloudFront-Viewer-Address` 头](/zh/images/cloudfront/origin-request-policy.png)
</Frame>

- 将 “Viewer protocol policy” 设置为 **Redirect HTTP to HTTPS**。

<Frame>
  ![CloudFront 的 "Create behavior" 页面，"Path pattern" 为 "/docs/*"，"Origin and origin groups" 指向 `acme.mintlify.dev` URL。](/zh/images/cloudfront/behavior-1.png)
</Frame>

### `/docs/*`

创建一个 **Path pattern** 为 `/docs/*` 的行为，并将 **Origin and origin groups** 指向相同的 `.mintlify.dev` URL。

除 **Path pattern** 外，其余设置应与 `/docs` 完全一致。

- 将 “Cache policy” 设置为 **CachingOptimized**。
- 将 “Origin request policy” 设置为 **VercelCloudFrontProxy**。
- 将 “Viewer protocol policy” 设置为 **Redirect HTTP to HTTPS**。

### `Default (*)`

最后，编辑 `Default (*)` 行为。

<Frame>
  ![选中 "Default (*)" 行为并强调 Edit 按钮的 CloudFront 分配。](/zh/images/cloudfront/default-behavior-1.png)
</Frame>

1. 将默认行为的 **Origin and origin groups** 更改为预发布环境 URL（此处为 `mintlify-landing-page.vercel.app`）。

<Frame>
  ![CloudFront 的 "Edit behavior" 页面，高亮显示 "Origin and origin groups" 输入框。](/zh/images/cloudfront/default-behavior-2.png)
</Frame>

2. 点击 **Save changes**。

### 检查行为是否配置正确

按上述步骤完成后，你的行为应如下所示：

<Frame>
  ![CloudFront 的 "Behaviors" 页面，包含 4 个行为：`/docs/*`、`/docs`、`Default` 和 `/.well-known/*`。](/zh/images/cloudfront/all-behaviors.png)
</Frame>

## 预览分发

你现在可以前往“General”选项卡，访问 **Distribution domain name** 的 URL，测试分发是否已正确配置。

<Frame>
  ![CloudFront「General」选项卡，高亮显示「Distribution domain name」URL。](/zh/images/cloudfront/preview-distribution.png)
</Frame>

所有页面应当指向你的主着陆页；但如果在 URL 末尾追加 `/docs`，则应跳转到你的 Mintlify 文档实例。

## 连接 Route53

现在，我们将把 CloudFront 分发的功能接入你的主域名。

<Note>
  在本节中，你也可以参考 AWS 的官方指南：[Configuring
  Amazon Route 53 to route traffic to a CloudFront
  distribution](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-cloudfront-distribution.html#routing-to-cloudfront-distribution-config)
</Note>

1. 在 AWS 控制台中进入 [Route53](https://aws.amazon.com/route53)。
2. 打开主域名对应的 “Hosted zone”。
3. 选择 **Create record**。

<Frame>
  ![Route 53 “Records” 页面，突出显示 “Create record” 按钮。](/zh/images/cloudfront/route53-create-record.png)
</Frame>

4. 打开 `Alias`，然后在 **Route traffic to** 中选择 `Alias to CloudFront distribution`。

<Frame>
  ![Route 53 “Create record” 页面，突出显示 “Alias” 开关和 “Route traffic to” 菜单。](/zh/images/cloudfront/create-record-alias.png)
</Frame>

5. 选择 **Create records**。

<Note>
  如果当前存在 A 记录，你可能需要先将其移除。
</Note>

你的文档现在已在主域名的 `/docs` 上线。

<Propagating />

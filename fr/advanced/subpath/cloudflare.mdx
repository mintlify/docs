---
title: "Cloudflare"
description: "Hébergez la documentation sur un sous-chemin personnalisé avec Cloudflare Workers"
---

import Propagating from "/snippets/fr/custom-subpath-propagating.mdx";

Pour héberger votre documentation sous un sous-chemin personnalisé tel que `yoursite.com/docs` avec Cloudflare, vous devrez créer et configurer un Cloudflare Worker.

<Info>
  Avant de commencer, vous devez disposer d’un compte Cloudflare et d’un nom de domaine (géré sur Cloudflare ou ailleurs).
</Info>


<div id="repository-structure">
  ## Structure du dépôt
</div>

Vos fichiers de documentation doivent être organisés dans votre dépôt de façon à refléter la structure de sous-chemin choisie. Par exemple, si vous souhaitez que votre documentation soit accessible à l’adresse `yoursite.com/docs`, créez un répertoire `docs/` contenant tous vos fichiers de documentation.

<div id="set-up-a-cloudflare-worker">
  ## Configurer un Cloudflare Worker
</div>

Créez un Cloudflare Worker en suivant le [guide de démarrage de Cloudflare Workers](https://developers.cloudflare.com/workers/get-started/dashboard/), si ce n’est pas déjà fait.

<Warning>
  Si votre fournisseur DNS est Cloudflare, n’activez pas le proxy pour l’enregistrement CNAME.
</Warning>

<div id="proxies-with-vercel-deployments">
  ### Proxies avec des déploiements Vercel
</div>

Si vous utilisez Cloudflare comme proxy avec des déploiements Vercel, veillez à une configuration adéquate pour éviter les conflits avec la vérification de domaine de Vercel et l’émission de certificats SSL.

Une mauvaise configuration du proxy peut empêcher Vercel d’émettre des certificats SSL Let's Encrypt et entraîner des échecs de vérification de domaine.

<div id="required-path-allowlist">
  #### Liste d’autorisation de chemins requise
</div>

Votre Cloudflare Worker doit autoriser le trafic vers ces chemins spécifiques sans le bloquer ni le rediriger :

- `/.well-known/acme-challenge/*` - Requis pour la vérification du certificat Let's Encrypt
- `/.well-known/vercel/*` - Requis pour la vérification de domaine Vercel

Bien que Cloudflare gère automatiquement de nombreuses règles de vérification, la création de règles personnalisées supplémentaires peut, par inadvertance, bloquer ce trafic essentiel.

<div id="header-forwarding-requirements">
  #### Exigences de transmission des en-têtes
</div>

Assurez-vous que l’en-tête `HOST` est correctement transmis dans la configuration de votre Worker. Une mauvaise transmission des en-têtes provoquera l’échec des requêtes de vérification.

<div id="configure-routing">
  ### Configurer le routage
</div>

Dans votre tableau de bord Cloudflare, sélectionnez **Edit Code** et ajoutez le script suivant au code de votre Worker. Consultez la [documentation Cloudflare](https://developers.cloudflare.com/workers-ai/get-started/dashboard/#development) pour en savoir plus sur la modification d’un Worker.

<Tip>
  Remplacez `[SUBDOMAIN]` par votre sous-domaine unique, `[YOUR_DOMAIN]` par l’URL de base de votre site web, et `/docs` par le sous-chemin souhaité, le cas échéant.
</Tip>

```javascript
addEventListener("fetch", (event) => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  try {
    const urlObject = new URL(request.url);
    
    // Si la requête vise un chemin de vérification Vercel, laissez-la passer
    if (urlObject.pathname.startsWith('/.well-known/')) {
      return await fetch(request);
    }
    
    // Si la requête cible le sous-répertoire des docs
    if (/^\/docs/.test(urlObject.pathname)) {
      // Alors mettre en proxy vers Mintlify
      const DOCS_URL = "[SUBDOMAIN].mintlify.dev";
      const CUSTOM_URL = "[YOUR_DOMAIN]";

      let url = new URL(request.url);
      url.hostname = DOCS_URL;

      let proxyRequest = new Request(url, request);

      proxyRequest.headers.set("Host", DOCS_URL);
      proxyRequest.headers.set("X-Forwarded-Host", CUSTOM_URL);
      proxyRequest.headers.set("X-Forwarded-Proto", "https");
      // Si vous déployez sur Vercel, préserver l’IP du client
      proxyRequest.headers.set("CF-Connecting-IP", request.headers.get("CF-Connecting-IP"));

      return await fetch(proxyRequest);
    }
  } catch (error) {
    // Si aucune action n’est trouvée, exécuter la requête normale
    return await fetch(request);
  }
}
```

Sélectionnez **Déployer** et attendez que les modifications se propagent.

<Propagating />


<div id="test-your-worker">
  ### Testez votre Worker
</div>

Après le déploiement de votre code, testez votre Worker pour vous assurer qu’il achemine bien vers votre documentation Mintlify.

1. Testez en utilisant l’URL d’aperçu du Worker : `your-worker.your-subdomain.workers.dev/docs`
2. Vérifiez que le Worker achemine correctement vers votre documentation Mintlify et votre site web.

<div id="add-custom-domain">
  ### Ajouter un domaine personnalisé
</div>

1. Dans votre [tableau de bord Cloudflare](https://dash.cloudflare.com/), accédez à votre Worker.
2. Allez dans **Settings > Domains & Routes > Add > Custom Domain**.
3. Ajoutez votre domaine.

<Tip>
  Nous vous recommandons d’ajouter votre domaine à la fois avec et sans le préfixe `www.`.
</Tip>

Consultez la section [Add a custom domain](https://developers.cloudflare.com/workers/configuration/routing/custom-domains/#add-a-custom-domain) de la documentation Cloudflare pour en savoir plus. 

<div id="resolve-dns-conflicts">
  ### Résoudre les conflits DNS
</div>

Si votre domaine pointe déjà vers un autre service, vous devez supprimer l’enregistrement DNS existant. Votre Cloudflare Worker doit être configuré pour gérer tout le trafic de votre domaine.

1. Supprimez l’enregistrement DNS existant de votre domaine. Consultez la section [Supprimer des enregistrements DNS](https://developers.cloudflare.com/dns/manage-dns-records/how-to/create-dns-records/#delete-dns-records) dans la documentation Cloudflare pour en savoir plus.
2. Retournez à votre Worker et ajoutez votre domaine personnalisé.

<div id="webflow-custom-routing">
  ## Routage personnalisé Webflow
</div>

Si vous utilisez Webflow pour héberger votre site principal et souhaitez publier la documentation Mintlify à `/docs` sur le même domaine, vous devrez configurer un routage personnalisé via Cloudflare Workers afin de faire proxy de tout le trafic non lié à la doc vers votre site principal.

<Warning>
  Assurez-vous que votre site principal pointe vers une page d’accueil (landing page) avant de déployer ce Worker, sinon les visiteurs de votre site principal verront des erreurs.
</Warning>

1. Dans Webflow, configurez une page d’accueil (landing page) pour votre site principal, par exemple `landing.yoursite.com`. Ce sera la page que les visiteurs verront lorsqu’ils se rendront sur votre site.
2. Déployez votre site principal sur cette page d’accueil. Cela garantit que votre site principal reste accessible pendant la configuration du Worker.
3. Pour éviter les conflits, remplacez les URL absolues de votre site principal par des URL relatives.
4. Dans Cloudflare, sélectionnez **Edit Code** et ajoutez le script suivant dans le code de votre Worker.

<Tip> Remplacez `[SUBDOMAIN]` par votre sous-domaine unique, `[YOUR_DOMAIN]` par l’URL de base de votre site, `[LANDING_DOMAIN]` par l’URL de votre page d’accueil, et `/docs` par le sous-chemin souhaité, le cas échéant. </Tip>

```javascript
  addEventListener("fetch", (event) => {
  event.respondWith(handleRequest(event.request));
  });
  async function handleRequest(request) {
  try {
    const urlObject = new URL(request.url);
    
    // Si la requête vise un chemin de vérification Vercel, laissez-la passer
    if (urlObject.pathname.startsWith('/.well-known/')) {
      return await fetch(request);
    }
    
    // Si la requête vise le sous-répertoire docs
    if (/^\/docs/.test(urlObject.pathname)) {
      // Faire transiter via Mintlify (proxy)
      const DOCS_URL = "[SUBDOMAIN].mintlify.dev";
      const CUSTOM_URL = "[YOUR_DOMAIN]";
      let url = new URL(request.url);
      url.hostname = DOCS_URL;
      let proxyRequest = new Request(url, request);
      proxyRequest.headers.set("Host", DOCS_URL);
      proxyRequest.headers.set("X-Forwarded-Host", CUSTOM_URL);
      proxyRequest.headers.set("X-Forwarded-Proto", "https");
      // Si vous déployez sur Vercel, conservez l’IP du client
      proxyRequest.headers.set("CF-Connecting-IP", request.headers.get("CF-Connecting-IP"));
      return await fetch(proxyRequest);
    }
    // Acheminer tout le reste vers le site principal
    const MAIN_SITE_URL = "[LANDING_DOMAIN]";
    if (MAIN_SITE_URL && MAIN_SITE_URL !== "[LANDING_DOMAIN]") {
      let mainSiteUrl = new URL(request.url);
      mainSiteUrl.hostname = MAIN_SITE_URL;
      return await fetch(mainSiteUrl, {
        method: request.method,
        headers: request.headers,
        body: request.body
      });
    }
  } catch (error) {
    // Si aucune action n’est trouvée, traiter la requête normalement
    return await fetch(request);
  }
  }
```

5. Sélectionnez **Deploy** et attendez que les modifications se propagent.

<Propagating />
